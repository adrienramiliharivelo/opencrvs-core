# 3.3.6 Deploy

{% hint style="warning" %}
As part of **OpenCRVS v1.2.0-beta (released December 2023),** we have changed the information on this page.  As a result these pages are being re-written/deprecated.  Please return in a few days for up to date content. &#x20;
{% endhint %}

### Automated continuous deployment

The easiest way to deploy OpenCRVS to your servers is to use [automated continuous deployment](https://www.atlassian.com/continuous-delivery/principles/continuous-integration-vs-delivery-vs-deployment).

Refer to our supplied [Github Action](https://github.com/opencrvs/opencrvs-farajaland/blob/develop/.github/workflows/deploy.yml) in the country configuration repo to set up appropriate environments for your use case or customise your own delivery pipeline.  You could rewrite our Action for use in [Gitlab](https://about.gitlab.com/), [Jenkins](https://www.jenkins.io/), [Travis](https://www.travis-ci.com/), [CircleCI](https://circleci.com/) or [Azure Pipelines](https://azure.microsoft.com/en-gb/products/devops/pipelines/) for example.

In our example, we have 3 environments provisioned in Github. These environments allow you to provision different subdomains, secrets and optional deployment properties depending on your chosen  environment when running the action.

1\.  To use our automated workflow, first you need to ensure that you have set up at least one, or optionally all, of the following Git [environments](https://docs.github.com/en/actions/deployment/targeting-different-environments/using-environments-for-deployment):

a) **Staging** - A useful environment for testing, where the environment variable NODE\_ENV is set to **development** and you can create test user accounts with a 6 zero "000000" 2FA code during login.  This allows us to see a debug experience.

b) **QA** - A quality assurance/pseudo production environment for software testers, where the environment variable NODE\_ENV is set to **production** and a secondary exception variable QA\_ENV is set to **true.**  This allows us to see a production like experience, but with the capability of still creating test user accounts with a 6 zero "000000" 2FA code during login.

c) **Production** - A live environment, where NODE\_ENV is set to **production** & QA\_ENV is set to **false**, SMS random 2FA is enabled so an SMS Gateway must be active.



2\.  Next, you need to create the following [Github secrets](https://docs.github.com/en/codespaces/managing-codespaces-for-your-organization/managing-encrypted-secrets-for-your-repository-and-organization-for-codespaces) for the usernames and passwords you created earlier when provisioning the servers using Ansible, along with other secrets Github will use to SSH into your servers, set the Traefik SSL hostname and connect to your container registry (E.G. Dockerhub) etc.

{% hint style="info" %}
Note: Using a strong password service such as [1Password](https://1password.com/) you should store the usernames and passwords you create in this section as you will need them regularly.
{% endhint %}

These secrets below can be set as **global repository secrets** in Github as they apply to all environments:

**Global repository secrets**

| Secret                             | Description                                                                                                                                                                                            |
| ---------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| ELASTICSEARCH\_SUPERUSER\_PASSWORD | The Elasticsearch superuser password.  You can also use this to login to Kibana with the username "**elastic**" and you have superuser Elastic privileges.  Kibana URL: https://kibana.\<your\_domain> |
| KIBANA\_USERNAME                   | A username for a regular Kibana user to login and monitor OpenCRVS stack health.  Useful for developers as this user will have no superuser privileges.                                                |
| KIBANA\_PASSWORD                   | A password for a regular Kibana user to login and monitor OpenCRVS stack health                                                                                                                        |
| MONGODB\_ADMIN\_USER               | The MongoDB superuser admin username.  A powerful account that has all rights to OpenCRVS data                                                                                                         |
| MONGODB\_ADMIN\_PASSWORD           | The MongoDB superuser admin password.                                                                                                                                                                  |
| MINIO\_ROOT\_USER                  | A username for a Minio superuser admin to login to the Minio console to view supporting document attachments submitted during registrations. https://minio-console.\<your\_domain>                     |
| MINIO\_ROOT\_PASSWORD              | A password for a Minio superuser admin                                                                                                                                                                 |
| DOCKER\_USERNAME                   | Your [Dockerhub](https://hub.docker.com/) username to access the container registry. If you are using a different container registry, you will need to manually edit the deploy.yml appropriately.     |
| DOCKER\_PASSWORD                   | Your [Dockerhub](https://hub.docker.com/) password.                                                                                                                                                    |
| DOCKERHUB\_ACCOUNT                 | The name of your Dockerhub account or organisation that forms the URL to your country config docker image on Dockerhub _**before**_ the slash. e.g: **opencrvs**                                       |
| DOCKERHUB\_REPO                    | The name of your Dockerhub repository that forms the URL to your country config docker image on Dockerhub _**after**_ the slash.. e.g. **ocrvs-farajaland**                                            |
| SMTP\_HOST                         | Described in [step 3.3.4](3.3.4-set-up-an-smtp-server-for-opencrvs-monitoring-alerts.md)                                                                                                               |
| SMTP\_PORT                         | Described in [step 3.3.4](3.3.4-set-up-an-smtp-server-for-opencrvs-monitoring-alerts.md)                                                                                                               |
| SMTP\_USERNAME                     | Described in [step 3.3.4](3.3.4-set-up-an-smtp-server-for-opencrvs-monitoring-alerts.md)                                                                                                               |
| SMTP\_PASSWORD                     | Described in [step 3.3.4](3.3.4-set-up-an-smtp-server-for-opencrvs-monitoring-alerts.md)                                                                                                               |
| ALERT\_EMAIL                       | Described in [step 3.3.4](3.3.4-set-up-an-smtp-server-for-opencrvs-monitoring-alerts.md)                                                                                                               |



__

3\.  The following secrets are likely to be unique for each environment so they should be duplicated as **environment secrets** in Github



**Environment secrets**

Github needs a [deployment SSH key](https://docs.github.com/en/developers/overview/managing-deploy-keys) to be enabled. This could be the id\_rsa.pub file that you use in your local computer to access.

{% hint style="warning" %}
In production, we recommend that SSH key access to servers is managed using a bastion with features for administrators that promote infrastructure security, including key management and auditing.  A good OpenSource Bastion is [Bastillion](https://www.bastillion.io/index.html).
{% endhint %}

KNOWN\_HOSTS - You will need the lines in your local computer's **.ssh/known\_hosts** file relevant to the environments that the SSH Key uses. This will have been generated using a test SSH connection using your key&#x20;

SSH\_KEY - Note: This is a copy of the **id\_rsa** file for your deploy key ... Not the id\_rsa.pub!&#x20;

STAGING\_DOMAIN or QA\_DOMAIN or PRODUCTION\_DOMAIN - the host **domain name** (without www!) for your environment. **You must make sure that you can ping this domain and that the ping resolves to your manager server's IP address.** If this does not resolve, there must be a problem with your A record configuration explained in the previous [step 3.3.5](3.3.5-setup-dns-a-records.md).&#x20;

REPLICAS - The number of replicas: **1, 3 or 5** depending on the setup introduced above.&#x20;

FACTORY\_RESET - **This is a destructive action for Staging and QA**. For production, set to **no** as you do not want each deployment to factory reset OpenCRVS. This is a process which deletes any registrations or users made and restores reference data explained in [step 3.2.6](../3.2-set-up-your-own-country-configuration/3.2.6-create-factory-reset-reference-data-backups.md). For Staging and QA, you can optionally set this to **yes** and OpenCRVS will reset on each deploy, deleting registrations and restoring all data. A useful option for developers and testers.

4\.  With these secrets the first **"Publish image to Dockerhub"** Github action is set to **automatically run** on your country configuration repository whenever code is pushed to a branch named master, main or develop. This action will build and push your Docker image to Dockerhub. **The image will be tagged with the short Git commit hash. This hash is important to refer to and use in the next step.**

****[**Publish image to Dockerhub: .github/workflows/publish-to-dockerhub.yml**](https://github.com/opencrvs/opencrvs-farajaland/blob/develop/.github/workflows/publish-to-dockerhub.yml)****

{% hint style="warning" %}
Our supplied Github Actions are examples that cannot be edited from a [fork](https://github.blog/2020-08-03-github-actions-improvements-for-fork-and-pull-request-workflows/).  You should duplicate these Github Actions files if you want to make changes for your infrastructure and update the branches that dispatch them ([here for example](https://github.com/opencrvs/opencrvs-farajaland/blob/master/.github/workflows/publish-to-dockerhub.yml#L5)) from master, develop to master-\<your country alpha3 code>, develop-\<your country alpha3 code> as we described in the fork [section 3.2.1](../3.2-set-up-your-own-country-configuration/3.2.1-fork-your-own-country-configuration-repository.md).
{% endhint %}



5\.  When the previous action has completed, you can deploy to your server with **the following manually triggered** action named **"Deploy"**.

a) You will be required to select the environment that you wish to deploy to.&#x20;

b) You will be required to enter the OpenCRVS Core version (or short Git hash tag for any tagged build on Dockerhub) to refer to the OpenCRVS Core release of choice.

c) You will be required to enter the OpenCRVS Farajaland version (or short Git hash tag for any tagged custom country configuration build on Dockerhub) to refer to your country configuration image created by the previous "Publish image to Dockerhub" action.

****[**Deploy: .github/workflows/deploy.yml.yml**](https://github.com/opencrvs/opencrvs-farajaland/blob/develop/.github/workflows/deploy.yml)****

Once the deployment is complete, wait a couple of minutes before browsing to OpenCRVS as it can take a little while for the Docker images to start up. If this is your first deployment, wait about 15 minutes as Docker must download these images from Dockerhub first.
